<div role=\ "main\" class=\ "ui-content\">
    <div class=\ "ui-body ui-body-a ui-corner-all loxberry-logo\">
        <div style=\ "margin: 5%;\">
    			<p class= "<TMPL_VAR NAME=MESSAGETYPE> maininfo"><TMPL_VAR NAME=MESSAGE></p>
            <h2>Einstellungen</h2>
            <div>
            		<p class="hint">In diesem Bereich bitte die korrekte Anzahl der benötigten Ein- und Ausgänge angeben. Nach dem Speichern wird die Kanalkonfiguration angepasst </p>
            </div>
            <form method="post" data-ajax="false" name="count_form" id="count_form" action="./index.cgi" class="separatingline">
              <input type="hidden" id="saveCount" name="saveCount" value="saveCount">
              <div class="ui-field-contain">
                <label id="input_count_label">Anzahl Eingänge:</label>
                <select name="input_count" id="input_count">
                  <TMPL_LOOP NAME=select_input_count>
                    <option value='<TMPL_VAR NAME=COUNT>'
                      <TMPL_VAR NAME=CHOOSED>><TMPL_VAR NAME=COUNT>
                    </option>
                  </TMPL_LOOP>
                </select>
              </div>
              <div class="ui-field-contain">
                <label id="input_count_label">Anzahl Ausgänge:</label>
                  <select name="output_count" id="output_count">
                    <TMPL_LOOP NAME=SELECT_OUTPUT_COUNT>
                      <option value='<TMPL_VAR NAME=COUNT>'
                        <TMPL_VAR NAME=CHOOSED>><TMPL_VAR NAME=COUNT>
                      </option>
                    </TMPL_LOOP>
                  </select>
              </div>

              <center>
                <button class="button" type="reset" form="count_form" id="btnreset" data-role="button" data-inline="true"
              	data-mini="true" data-icon="check">Reset</button>
              	<button class="button" type="submit" form="count_form" id="btnsubmit" data-role="button" data-inline="true"
              	data-mini="true" data-icon="check">Speichern</button>
              </center>
            </form>

            <h2>Kanalkonfiguration</h2>
            <div>
            		<p class="hint">Hier werden die Zuordnungen der physikalischen Anschlüsse des Raspberrys zu den Kanälen der Ein- und Ausgänge vorgenommen.
            		In das Eingabefeld wird hierfür für jeden Kanal der verwendete GPIO Anschluss eingetragen. Die GPIO Pin Belegung kann hier nachgelesen werden: <a href="https://www.raspberrypi.org/documentation/usage/gpio/">https://www.raspberrypi.org/documentation/usage/gpio/</a></p>
            </div>
            <form method="post" data-ajax="false" name="main_form" id="main_form" action="./index.cgi">
        		<input type="hidden" id="saveIoConfig" name="saveIoConfig" value="saveIoConfig">
        		<div class="class="ui-field-contain"">
	          <h3>Eingänge</h3>

       			<TMPL_LOOP NAME=number_of_inputs>
       				<div class=" ui-field-contain">
       					<label class= "<TMPL_VAR NAME=class>">Eingang <TMPL_VAR NAME=current>:</label>
                <fieldset>
                  <div class="gpioconf <TMPL_VAR NAME=class>">
                    <input type='text' id="input<TMPL_VAR NAME=current>" name="input<TMPL_VAR NAME=current>" value="<TMPL_VAR value>"></input>
       						  <p class="error_hint"><TMPL_VAR NAME=errormessage></p>
                    <p class="info_text">LoxoneConfig <a href="#popupInfo<TMPL_VAR NAME=current>" data-rel="popup" data-transition="pop" style="background:none" class="info_icon my-tooltip-btn ui-btn ui-alt-icon ui-nodisc-icon ui-btn-inline ui-icon-info ui-btn-icon-notext" title="Show more">Show more</a></p>
                    <div data-role="popup" id="popupInfo<TMPL_VAR NAME=current>" class="ui-content" data-theme="a" style="max-width:700px;">
                      <span class="info_text_headline">Konfiguration des Eingangs <TMPL_VAR NAME=current> in der LoxoneConfig</span>
                      <span class="info_text_subline mono">Name des Eingangs:</span>
                      <table>
                        <tr>
                          <td>Wert:</td>
                          <td class="param"><TMPL_VAR NAME=hostname>_gpio_<TMPL_VAR value>_state</td>
                        </tr>
                        <tr>
                          <td>Wert als Text:</td>
                          <td class="param"><TMPL_VAR NAME=hostname>_gpio_<TMPL_VAR value>_stateText</td>
                        </tr>
                        <tr>
                          <td>Zeitstempel Ein:</td>
                          <td class="param"><TMPL_VAR NAME=hostname>_gpio_<TMPL_VAR value>_timestamp_ON</td>
                        </tr>
                        <tr>
                          <td>Zeitstempel Aus:</td>
                          <td class="param"><TMPL_VAR NAME=hostname>_gpio_<TMPL_VAR value>_timestamp_OFF</td>
                        </tr>
                      </table>
                    </div>
                  </div>
       		<div class="wiring">
         		<TMPL_VAR SELECTLIST>
       		</div>
                </fieldset>
              </div>
       	</TMPL_LOOP>
            <h3>Ausgänge</h3>
            <div class=" ui-field-contain">

            </div>
       			<TMPL_LOOP NAME=number_of_outputs>
       				<div class="<TMPL_VAR NAME=class> ui-field-contain">
       					<label class= "<TMPL_VAR NAME=class>">Ausgang <TMPL_VAR NAME=current>:</label>
                <fieldset>
                  <input class= "<TMPL_VAR NAME=class>" type='text' id="output<TMPL_VAR NAME=current>" name="output<TMPL_VAR NAME=current>" value="<TMPL_VAR value>"></input>
       						<p class="error_hint"><TMPL_VAR NAME=errormessage></p>
                  <p class="info_text">LoxoneConfig <a href="#popupInfoOutput<TMPL_VAR NAME=current>" data-rel="popup" data-transition="pop" style="background:none" class="info_icon my-tooltip-btn ui-btn ui-alt-icon ui-nodisc-icon ui-btn-inline ui-icon-info ui-btn-icon-notext" title="Show more">Show more</a></p>
                  <div data-role="popup" id="popupInfoOutput<TMPL_VAR NAME=current>" class="ui-content" data-theme="a" style="max-width:700px;">
                    
                    <span class="info_text_headline">Konfiguration des Ausgangs <TMPL_VAR NAME=current> in der LoxoneConfig</span>
                    <span class="info_text_subline mono">Virtueller Ausgang Befehl:</span>
                    <table>
                      <tr>
                        <td>Befehl für EIN:</td>
                        <td class="param">publish <TMPL_VAR NAME=hostname>/gpio/set/<TMPL_VAR value> on</td>
                      </tr>
                      <tr>
                        <td>Befehl für AUS:</td>
                        <td class="param">publish <TMPL_VAR NAME=hostname>/gpio/set/<TMPL_VAR value> off</td>
                      </tr>
                    </table>
                    <span class="info_text_subline mono">Antworten als Eingänge:</span>
                    <table>
                      <tr>
                        <td>Wert:</td>
                        <td class="param"><TMPL_VAR NAME=hostname>_gpio_<TMPL_VAR value>_state</td>
                      </tr>
                      <tr>
                        <td>Wert als Text:</td>
                        <td class="param"><TMPL_VAR NAME=hostname>_gpio_<TMPL_VAR value>_stateText</td>
                      </tr>
                      <tr>
                        <td>Zeitstempel Ein:</td>
                        <td class="param"><TMPL_VAR NAME=hostname>_gpio_<TMPL_VAR value>_timestamp_ON</td>
                      </tr>
                      <tr>
                        <td>Zeitstempel Aus:</td>
                        <td class="param"><TMPL_VAR NAME=hostname>_gpio_<TMPL_VAR value>_timestamp_OFF</td>
                      </tr>
                    </table>

                  </div>
                </fieldset>
       				</div>
       			</TMPL_LOOP>

            <h3>MQTT</h3>
            <div>
		    <p class="hint">Das Plugin sendet den Status der GPIOs an einen MQTT Broker. Von dort aus kann die Auswertung über die LoxoneConfig erfolgen. Wenn das MQTT Gateway Plugin auf diesem LoxBerry installiert ist, kannst Du die Zugangsdaten automatisch von dort übernehmen lassen. Ansonsten musst Du die Verbindungsdaten zu Deinem MQTT Broker manuell angeben.</p>
            </div>

	<TMPL_IF MQTTGATEWAY_INSTALLED>
			<div class="ui-field-contain">
			<label	class="info"></label>
				<div	class="gpioconf info">
					<label	class=	"control-label" for="mqttusemqttgateway">Verwende MQTT Gateway Einstelllungen</label>
					<input type="checkbox" name="mqttusemqttgateway" id="mqttusemqttgateway" <TMPL_VAR NAME=MQTTUSEMQTTGATEWAYCHECKED>>	
					<span id="mqtt_onverviewlink"></span>
				</div>
			</div>
		
	</TMPL_IF>
	
	<div class="ui-field-contain ui-state-disabled ownbroker">
			<label	class="info">MQTT Broker Server</label>
		<div	class="gpioconf info">
			<input width="100%" id="mqttbrokerserver" name="mqttbrokerserver" type="text" class="textfield" value="<TMPL_VAR MQTTBROKERSERVER>">
		</div>
	</div>
	<div class="ui-field-contain ui-state-disabled ownbroker">
			<label	class="info">MQTT Broker Port</label>
		<div	class="gpioconf info">
			<input width="100%" id="mqttbrokerport" name="mqttbrokerport" type="text" class="textfield" value="<TMPL_VAR MQTTBROKERPORT>">
		</div>
	</div>
	<div class="ui-field-contain ui-state-disabled ownbroker">
			<label	class="info">MQTT Broker Username</label>
		<div	class="gpioconf info">
			<input width="100%" id="mqttbrokerusername" name="mqttbrokerusername" type="text" class="textfield" value="<TMPL_VAR MQTTBROKERUSERNAME>">
		</div>
	</div>
	<div class="ui-field-contain ui-state-disabled ownbroker">
			<label	class="info">MQTT Broker Password</label>
		<div	class="gpioconf info">
			<input width="100%" id="mqttbrokerpassword" name="mqttbrokerpassword" type="text" class="textfield" value="<TMPL_VAR MQTTBROKERPASSWORD>">
		</div>
	</div>
	<div class="ui-field-contain ui-state-disabled ownbroker">
			<label	class="info">MQTT Subscription</label>
		<div	class="gpioconf info">
			<input width="100%" id="mqttsubscription" name="mqttsubscription" type="text" class="textfield" value="<TMPL_VAR MQTTSUBSCRIPTION>" readonly>
		</div>
	</div>
		

            <center>
              <button class="button" type="reset" form="main_form" id="btnreset2" data-role="button" data-inline="true"
              data-mini="true" data-icon="check">Reset</button>
              <button class="button" type="submit" form="main_form" id="btnsubmit2" data-role="button" data-inline="true"
              data-mini="true" data-icon="check">Speichern</button>
            </center>
          </form>
      </div>
    </div>
</div>

<script>
$(function() {

	$("#mqtt_onverviewlink").html('<a href="http://'+window.location.host+'/admin/plugins/mqttgateway/index.cgi?form=topics" target="_blank">Öffne MQTT Gateway Incoming Übersicht</a>');
	refreshMQTTForm();

});

function refreshMQTTForm() {
	console.log("refreshmqttform");
	$(".MQTT").removeClass("ui-state-disabled");
	if( $("#mqttusemqttgateway").is(":checked") )
		$(".ownbroker").addClass("ui-state-disabled");
	else
		$(".ownbroker").removeClass("ui-state-disabled");
}

$("#mqttusemqttgateway").on("click", refreshMQTTForm);

</script>
